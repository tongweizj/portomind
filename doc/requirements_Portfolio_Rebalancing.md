

## 组合再平衡（Portfolio Rebalancing）
是资产配置中的核心操作，它可以帮助长期投资者保持风险与收益的理想结构。
我们在 PortoMind 中实现这一功能，可以分为 4 大模块：

---

### 🧠 一、再平衡功能设计目标

> 🎯 让用户为每个组合设定**目标配置**，并根据**当前价格**与**实际持仓**，判断是否偏离，提出调仓建议。

---

### ✅ 二、核心模块拆解

#### 1️⃣ 设定目标比例（目标配置 UI）

##### 🔧 后端数据结构（嵌入在 Portfolio 中）：

```js
targets: [
  { symbol: 'VTI', targetRatio: 50 },
  { symbol: 'VXUS', targetRatio: 30 },
  { symbol: 'BND', targetRatio: 20 }
]
```

##### ✅ UI 功能：

- 组合详情页中提供「目标配置」编辑表单
- 支持动态添加资产和设定百分比（合计 100%）

---

#### 2️⃣ 实时持仓比例计算（actual ratios）

##### 📦 数据来源：

- 所有交易记录（按 portfolioId 分组）
- 最新价格（来自 Price 表）

##### 💡 示例计算逻辑：

```js
// 对每个资产计算：
持仓金额 = 当前价格 × 持仓数量
组合总市值 = 所有资产金额之和
实际比例 = 资产金额 / 总市值 × 100%
```

##### ✅ 后端接口建议：

```
GET /api/portfolios/:id/actual-ratios
```

返回结构：

```json
[
  { "symbol": "VTI", "ratio": 48.2 },
  { "symbol": "VXUS", "ratio": 31.5 },
  { "symbol": "BND", "ratio": 20.3 }
]
```

---

#### 3️⃣ 是否需要再平衡（触发机制）

##### 可选触发条件：

| 条件类型 | 示例说明 |
|----------|-----------|
| ⏱ 时间 | 每月、每季度自动建议 |
| 📉 偏差阈值 | 任一资产偏离目标比例 > 5% |
| 🚀 涨跌幅触发 | 某资产价格大幅上涨导致比例偏移 |

##### ✅ 后端接口建议：

```
GET /api/portfolios/:id/should-rebalance
```

返回：

```json
{
  "needed": true,
  "reason": "VTI 当前占比 58%，超过目标比例 50% 的 ±5% 范围",
  "suggestedDate": "2025-05-01"
}
```

---

#### 4️⃣ 调仓建议计算（生成买卖指令）

##### 目标：

- 根据实际 vs 目标，生成「买入 / 卖出」操作建议
- 尽量少交易、保持总市值不变

##### ✅ 返回结构建议：

```json
[
  { "symbol": "VTI", "action": "sell", "quantity": 5 },
  { "symbol": "VXUS", "action": "buy", "quantity": 3 }
]
```

##### ✅ 后端接口建议：

```
GET /api/portfolios/:id/rebalance-plan
```

---

### 🎯 三、用户界面建议（前端功能）

| 页面 | 功能 |
|------|------|
| PortfolioDetail 页面 | 添加 “目标配置” 表单区块 |
| PortfolioStats 页面 | 实际比例饼图 vs 目标比例对比图 |
| Rebalance 页面（新） | 列出调仓建议、允许导出 / 生成模拟交易 |

---

### 📌 四、未来扩展功能（可选）

- [ ] 点击确认再平衡后，自动生成交易记录（模拟交易）
- [ ] 对再平衡前后资产占比进行可视化动画对比
- [ ] 导出为 CSV 调仓建议
- [ ] 加入自动触发再平衡并通知（短信、邮箱）

---

是否要我为你生成：
- 目标配置的数据模型更新？
- 再平衡计算 API 初始版本？
- 前端页面建议布局草图？

我们可以一步步构建这一高级功能 ✅